{% extends "base.html" %}

{% block title %}Manifest List{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4">
    <h1 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Manifest List</h1>
    
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4 sm:mb-6">
        <div class="flex-1 max-w-full sm:max-w-lg">
            <input type="text" 
                   id="searchInput"
                   name="search"
                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2" 
                   placeholder="Search..." 
                   value="{{ search or '' }}"
                   hx-get="{{ url_for('manifest.list_manifest') }}"
                   hx-trigger="keyup changed delay:300ms"
                   hx-target="#tableContainer"
                   hx-include="[name='page_size']"
                   autofocus>
            {% if search %}
            <div class="mt-2">
                <a href="{{ url_for('manifest.list_manifest') }}" class="text-sm text-blue-600 hover:text-blue-800">
                    Clear search
                </a>
            </div>
            {% endif %}
        </div>

        <div class="flex items-center">
            <a href="{{ url_for('manifest.create_manifest') }}" 
               class="w-full sm:w-auto px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 text-center">
                Add New
            </a>
        </div>
    </div>

    <div class="border rounded-lg shadow-sm bg-white overflow-hidden">
        <div id="tableContainer" class="overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100" style="height: calc(100vh - 280px); min-height: 400px;">
            {% include "manifest/table.html" %}
        </div>

        <div class="p-3 sm:p-4 border-t bg-white sticky bottom-0 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
            <div id="selectedBill" class="text-sm text-gray-900 font-medium min-w-0 sm:min-w-[200px] truncate"></div>
            <div class="flex items-center gap-2 sm:gap-4">
                <select id="pageSize" 
                        name="page_size"
                        class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                        hx-get="{{ url_for('manifest.list_manifest') }}"
                        hx-target="#tableContainer"
                        hx-include="[name='search']"
                        hx-trigger="change">
                    <option value="3" {% if page_size == 3 %}selected{% endif %}>3 per page</option>
                    <option value="5" {% if page_size == 5 %}selected{% endif %}>5 per page</option>
                    <option value="10" {% if page_size == 10 %}selected{% endif %}>10 per page</option>
                    <option value="25" {% if page_size == 25 %}selected{% endif %}>25 per page</option>
                    <option value="50" {% if page_size == 50 %}selected{% endif %}>50 per page</option>
                    <option value="100" {% if page_size == 100 %}selected{% endif %}>100 per page</option>
                </select>
                {% if has_more %}
                <button hx-get="{{ url_for('manifest.list_manifest', page=page+1) }}"
                        hx-target="#manifestTableBody"
                        hx-swap="beforeend"
                        hx-include="[name='page_size'], [name='search'], [name='sort']"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 text-sm whitespace-nowrap">
                    Load More
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.selected-row {
    background-color: #EBF5FF !important;
}

/* Custom scrollbar styles */
.scrollbar-thin::-webkit-scrollbar {
    height: 8px;
    width: 8px;
}

.scrollbar-thin::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
}

.scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

@media (max-width: 640px) {
    .scrollbar-thin::-webkit-scrollbar {
        height: 4px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let searchTimeout;
    const searchInput = document.getElementById('searchInput');
    const tableContainer = document.getElementById('tableContainer');
    const pageSizeSelect = document.getElementById('pageSize');
    let selectedRow = null;

    // Function to adjust table container height based on page size
    function adjustTableHeight() {
        const pageSize = parseInt(pageSizeSelect.value);
        const viewportHeight = window.innerHeight;
        const headerHeight = 180; // Approximate height of header elements
        const footerHeight = 100; // Approximate height of footer elements
        
        if (viewportHeight < 640) { // Mobile viewport
            tableContainer.style.height = `${viewportHeight - headerHeight - footerHeight}px`;
            tableContainer.style.minHeight = '300px';
        } else if (pageSize < 5) {
            tableContainer.style.height = 'calc(50vh - 140px)';
            tableContainer.style.minHeight = '300px';
        } else {
            tableContainer.style.height = 'calc(100vh - 280px)';
            tableContainer.style.minHeight = '400px';
        }
    }

    // Initial height adjustment
    adjustTableHeight();

    // Adjust height on window resize
    window.addEventListener('resize', adjustTableHeight);

    // Adjust height when page size changes
    pageSizeSelect.addEventListener('change', adjustTableHeight);

    // Function to handle row selection
    window.selectRow = function(row, billOfLading) {
        // Remove highlight from previously selected row
        if (selectedRow) {
            selectedRow.classList.remove('selected-row');
        }
        
        // Highlight the clicked row
        row.classList.add('selected-row');
        selectedRow = row;
        
        // Update the selected bill display
        const selectedBill = document.getElementById('selectedBill');
        selectedBill.textContent = billOfLading;
    };

    // Handle search functionality
    function performSearch() {
        const searchTerm = searchInput.value;
        const pageSize = pageSizeSelect.value;
        const url = new URL(window.location.href);
        url.searchParams.set('search', searchTerm);
        url.searchParams.set('page_size', pageSize);
        url.searchParams.set('page', '1');

        fetch(url)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newResults = doc.querySelector('#tableContainer').innerHTML;
                tableContainer.innerHTML = newResults;
                
                // Clear selected bill when search results change
                document.getElementById('selectedBill').textContent = '';
                selectedRow = null;
            })
            .catch(error => console.error('Error:', error));
    }

    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
    });

    // Handle HTMX after-swap event to maintain selection
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (selectedRow) {
            const billOfLading = selectedRow.dataset.bill;
            const newRow = document.querySelector(`tr[data-bill="${billOfLading}"]`);
            if (newRow) {
                newRow.classList.add('selected-row');
                selectedRow = newRow;
                document.getElementById('selectedBill').textContent = billOfLading;
            }
        }
        // Re-adjust table height after content changes
        adjustTableHeight();
    });

    // Handle click events on the table container
    tableContainer.addEventListener('click', function(e) {
        const row = e.target.closest('tr[data-selectable="true"]');
        if (row) {
            const billOfLading = row.dataset.bill;
            selectRow(row, billOfLading);
        }
    });
});
</script>
{% endblock %}
