{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">People</h1>

    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-4"
            hx-get="{{ url_for('create') }}"
            hx-target="#modal"
            hx-swap="innerHTML"
            hx-trigger="click">
        Add Person
    </button>

    <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
        <div id="people-container" data-total-records="{{ people|length }}" class="overflow-y-auto max-h-[calc(80vh-16rem)]">
            <table id="people-table" class="w-full text-sm text-left text-gray-500 ">
                <thead class="text-xs text-gray-700 uppercase bg-gray-200 sticky top-0">
                    <tr>
                        <th scope="col" class="py-3 px-2">ID</th>
                        <th scope="col" class="py-3 px-2">Name</th>
                        <th scope="col" class="py-3 px-2">Age</th>
                        <th scope="col" class="py-3 px-6 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="people-tbody">
                    {% include 'table_body.html' %}
                </tbody>

            </table>
            
            <div class="flex justify-end m-4>">
                <button id="load-more" 
                    class="hover:bg-slate-300 py-1 px-2 text-xs rounded m-4 align-right"
                    hx-headers='{"Cache-Control": "no-cache"}'
                    hx-get="{{ url_for('load_more') }}"
                    hx-trigger="click"
                    hx-target="#people-tbody"
                    hx-swap="beforeend"
                    hx-indicator="#load-more"
                    data-offset="{{ people|length }}"
                    data-records-per-page="{{ records_per_page }}"
                    {% if people|length < records_per_page %}disabled{% endif %}>
                    Load More ... (Offset: <span id="current-offset">{{ people|length }}</span>)
                </button>

                {% if people|length == 0 %}
                    <p class="text-center">No more records</p>
                {% endif %}
            </div> 
        </div>
    </div>

    <div id="selected-row" class="mt-4 p-4 bg-gray-100 rounded-lg">
        <p>Selected ID: <span id="selected-id" class="font-bold">None</span></p>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
         _="on htmx:afterSwap remove .hidden">
    </div>
</div>

<script>
    console.log("Script loaded");
    
    document.body.addEventListener('htmx:configRequest', function(event) {
        if (event.detail.elt.id === 'load-more') {
            var offset = parseInt(event.detail.elt.getAttribute('data-offset'));
            event.detail.parameters['offset'] = offset;
        }
    });
    
    document.body.addEventListener('htmx:afterOnLoad', function(event) {
        console.log("htmx:afterOnLoad event triggered", event.detail);
        if (event.detail.elt.id === 'load-more') {
            console.log("Load more button clicked");
            var loadMoreBtn = document.getElementById('load-more');
            var currentOffsetSpan = document.getElementById('current-offset');
            var recordsPerPage = parseInt(loadMoreBtn.getAttribute('data-records-per-page'));
            var currentOffset = parseInt(loadMoreBtn.getAttribute('data-offset'));
            var newOffset = currentOffset + recordsPerPage;
    
            console.log('Current offset:', currentOffset);
            console.log('New offset:', newOffset);
    
            currentOffsetSpan.textContent = newOffset;
            loadMoreBtn.setAttribute('data-offset', newOffset);
            console.log("New data-offset value:", loadMoreBtn.getAttribute('data-offset'));
    
            if (event.detail.xhr.getResponseHeader('Hx-Trigger') === '{"noMoreRecords":true}') {
                loadMoreBtn.setAttribute('disabled', 'disabled');
            }

            var triggerHeader = event.detail.xhr.getResponseHeader('HX-Trigger');  
            if (triggerHeader && JSON.parse(triggerHeader).noMoreRecords) {
                loadMoreBtn.disabled = true;
                loadMoreBtn.classList.add('opacity-50', 'cursor-not-allowed');
                loadMoreBtn.textContent = 'No More Records';  // Add this line
            }
        }
    });
    
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        console.log("htmx:beforeRequest - URL:", event.detail.requestConfig.url);
        console.log("htmx:beforeRequest - Parameters:", event.detail.requestConfig.parameters);
    });

</script>
{% endblock %}
